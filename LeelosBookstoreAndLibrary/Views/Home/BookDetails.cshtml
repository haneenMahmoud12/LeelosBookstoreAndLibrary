@model LeelosBookstoreAndLibrary.Models.Book

@{
    ViewBag.Title = "BookDetails";
}

@if (TempData["Message"] != null)
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />

    <style>
        /* Custom style to make toastr success green */
        .toast-success {
            background-color: #28a745 !important; /* Bootstrap green */
        }
    </style>

    <script>
        $(document).ready(function () {
            toastr.success('@TempData["Message"]', 'Success', { timeOut: 5000 });
        });
    </script>
}

@if (TempData["ErrorMessage"] != null)
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            toastr.error('@TempData["ErrorMessage"]', 'Error', { timeOut: 5000 });
        });
    </script>
}


@*<partial name="_Notification" />
*@
<h2>Book Details</h2>


@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            <p>@error.ErrorMessage</p>
        }
    </div>
}


<!-- Book Details Section -->
<div>
    <hr />
    <dl class="dl-horizontal">
        <dt>@Html.DisplayNameFor(model => model.Title)</dt>
        <dd>@Html.DisplayFor(model => model.Title)</dd>

        <dt>@Html.DisplayNameFor(model => model.Description)</dt>
        <dd>@Html.DisplayFor(model => model.Description)</dd>

        <dt>Author</dt>
        <dd>@Html.DisplayFor(model => model.Author.FirstName) @Html.DisplayFor(model => model.Author.LastName)</dd>

        <dt>@Html.DisplayNameFor(model => model.Genre)</dt>
        <dd>@Html.DisplayFor(model => model.Genre)</dd>

        <dt>@Html.DisplayNameFor(model => model.Price)</dt>
        <dd>@($"{Math.Round(Model.Price,2)}")</dd>

        <dt>@Html.DisplayNameFor(model => model.Rating)</dt>
        <dd>@Html.DisplayFor(model => model.Rating)</dd>

        <dt>Publisher</dt>
        <dd>@Html.DisplayFor(model => model.Publisher.Name)</dd>

        <dt>@Html.DisplayNameFor(model => model.DatePublished)</dt>
        <dd>@Html.DisplayFor(model => model.DatePublished)</dd>

        <dt>@Html.DisplayNameFor(model => model.NumberOfPages)</dt>
        <dd>@Html.DisplayFor(model => model.NumberOfPages)</dd>


        @if (Model.StockQuantity > 0) // Ensure the book is available
        {
            if ((Session["UserId"] != null && (int)Session["UserId"] == 1) || (Session["UserId"] == null))
            {
                <!-- Add to Cart Section -->
                <form action="@Url.Action("AddToCart", "ShoppingCart")" method="post">
                    @Html.Hidden("bookId", Model.Id)
                    <label>Quantity: </label>
                    <input type="number" name="quantity" value="1" min="1" max="@Model.StockQuantity" />
                    <button type="submit" class="btn btn-primary">Add to Cart</button>
                </form>

                <!-- Borrow Section -->
                <form action="@Url.Action("AddToBorrowCart", "Borrow")" method="post">
                    @Html.Hidden("bookId", Model.Id)
                    <button type="submit" class="btn btn-primary">Borrow</button>
                </form>
            }


        }
        else if (Model.StockQuantity <= 0 && (int)Session["UserId"] == 1)
        {
            <span>Out of stock</span>
        }
    </dl>
</div>

<!-- Admin Actions -->
<p>
    @if (!string.IsNullOrEmpty(Session["UserId"]?.ToString()) && (int)Session["UserRole"] == 2)
    {
        @Html.ActionLink("Edit", "EditBook", new { id = Model.Id })
        @Html.Label("|")
        <a href="#" onclick="showDeleteModal(@Model.Id, '@Model.Title'); return false;">Delete</a>
        <br />
    }

    @Html.ActionLink("Back to Home Page", "Index")
</p>

<!-- Confirm Delete Modal -->
<div class="modal" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this book <strong id="deleteBookTitle"></strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>


<!-- JavaScript for handling modal and delete -->
<script type="text/javascript">
    function showDeleteModal(bookId, bookTitle) {
        // Set the book title in the modal
        document.getElementById("deleteBookTitle").textContent = bookTitle;

        // Set the action for the confirm delete button
        document.getElementById("confirmDeleteBtn").onclick = function () {
            deleteBook(bookId);
        };

        // Show the modal
        var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    function deleteBook(bookId) {
        const form = document.createElement("form");
        form.method = "post";
        form.action = '@Url.Action("DeleteBook")';

        const hiddenField = document.createElement("input");
        hiddenField.type = "hidden";
        hiddenField.name = "id";
        hiddenField.value = bookId;

        form.appendChild(hiddenField);
        document.body.appendChild(form);
        form.submit();
    }
</script>