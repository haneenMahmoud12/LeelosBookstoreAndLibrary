@model LeelosBookstoreAndLibrary.Models.BooksViewModel

@{
    ViewBag.Title = "Books";
}

<h2>Books</h2>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="~/Scripts/datatables.js"></script>
<link href="~/Scripts/datatables.css" rel="stylesheet" />

@if (TempData["Message"] != null)
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />

    <style>
        /* Custom style to make toastr success green */
        .toast-success {
            background-color: #28a745 !important; /* Bootstrap green */
        }
    </style>

    <script>
        $(document).ready(function () {
            toastr.success('@TempData["Message"]', 'Success', { timeOut: 5000 });
        });
    </script>
}

@if (TempData["ErrorMessage"] != null)
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />

    <script>
        $(document).ready(function () {
            toastr.error('@TempData["ErrorMessage"]', 'Error', { timeOut: 5000 });
        });
    </script>
}

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            <p>@error.ErrorMessage</p>
        }
        <a href="~/Views/Home/EditBook.cshtml">Edit Book</a>
    </div>
}

<!-- Search form -->
@*<form method="get" action="@Url.Action("Index")">
    <input type="text" name="searchQuery" placeholder="Search by title, author, or genre..." value="@Model.SearchQuery" />
    <input type="submit" value="Search" />
</form>*@

<!-- Add book link for admin -->
@if (!string.IsNullOrEmpty(Session["UserId"]?.ToString()) && (int)Session["UserRole"] == 2)
{
    <br />
    <p>
        @Html.ActionLink("Add Book", "AddBook")
    </p>
}

<div>
    <!-- Ensure DataTables CSS is included in layout or here -->
    <!-- <link href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css" rel="stylesheet"> -->

    <table id="booksTable" class="table table-striped table-bordered" style="width:100%">
        <thead>
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Genre</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- DataTables will populate data here -->
        </tbody>
    </table>

    <script>
            $(document).ready(function () {
                $('#booksTable').DataTable({
                    "processing": true,
                    "serverSide": true,
                    "ajax": {
                        "url": "@Url.Action("Index", "Home")",
                        "type": "POST",
                        "error": function (xhr, error, thrown) {
                            toastr.error('An error occurred while processing your request.', 'Error', { timeOut: 5000 });
                        }
                    },
                    "columns": [
                        { "data": "Title" },
                        { "data": "Author" },
                        { "data": "Genre" },
                        { "data": "Price" },
                        {
                            "data": "Id",
                            "render": function (data, type, row) {
                                return '<a href="/Home/BookDetails/' + data + '" class="btn btn-primary btn-sm">Details</a>';
                            },
                            "orderable": false,
                            "searchable": false
                        }
                    ],
                    "paging": true,
                    "ordering": true,
                    "searching": true,
                    "pageLength": 4,
                    "lengthMenu": [4, 10, 20, 100],
                    "order": [[0, "asc"]],
                    "language": {
                        "processing": "Loading..."
                    }
                });
            });
    </script>
</div>
